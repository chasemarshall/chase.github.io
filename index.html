<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chase Marshall</title>
  <!-- Fonts & reset styles (unchanged) -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap');
    :root {
      --bg: #0f0f0f;  --text:#e4e4e4;  --text-dim:#a1a1a1;  --accent:#6366f1;
      --border:#262626; --hover:#1a1a1a;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:'Inter',system-ui,sans-serif;line-height:1.6;overflow-x:hidden}
    /* … keep the rest of your CSS exactly as you had it … */
  </style>
</head>
<body>
  <div class="container">
    <!-- header / nav / sections markup (unchanged) -->

    <!-- ──────────────── Music Player Section ──────────────── -->
    <section id="music" class="section">
      <h2>$ now_playing</h2>
      <div class="music-player">
        <div id="albumArtContainer" class="album-art-placeholder">🎵</div>
        <div class="player-controls" style="margin-top:1rem;gap:1rem;align-items:center;">
          <button id="playBtn" class="play-btn">▶</button>
          <div class="track-info">
            <div id="trackName" class="track-name">loading…</div>
            <div id="trackArtist" class="track-artist"></div>
          </div>
          <span id="currentTime">0:00</span>
          <div style="flex:1;height:6px;background:var(--border);border-radius:4px;overflow:hidden;cursor:pointer" onclick="seekTo(event)">
            <div id="progress" style="height:100%;width:0%;background:var(--accent);"></div>
          </div>
          <span id="duration">0:00</span>
        </div>
        <!-- hidden HTML5 preview player -->
        <audio id="htmlAudioPlayer" preload="none" style="display:none;"></audio>
        <!-- Spotify iframe embed (starts hidden) -->
        <iframe id="spotifyPlayer" style="display:none;border:none;width:100%;height:152px;border-radius:12px;" allow="encrypted-media"></iframe>
      </div>
      <p id="musicDescription" style="margin-top:1rem;color:var(--text-dim);font-size:.85rem">
        this is what i'm vibing to right now – click play to hear a preview, or click the track name to open in spotify.
      </p>
    </section>
  </div>

  <!-- ───────────────── Spotify Integration ───────────────── -->
  <script>
  /* 1. Endpoint */
  const SPOTIFY_API_ENDPOINT = 'https://spotify-api-eight-pi.vercel.app/api/spotify';

  /* 2. DOM handles */
  const embedFrame    = document.getElementById('spotifyPlayer');
  const albumArtBox   = document.getElementById('albumArtContainer');
  const htmlPlayerEl  = document.getElementById('htmlAudioPlayer');
  const playBtn       = document.getElementById('playBtn');
  const trackNameEl   = document.getElementById('trackName');
  const trackArtistEl = document.getElementById('trackArtist');
  const progressBar   = document.getElementById('progress');
  const currentTimeEl = document.getElementById('currentTime');
  const durationEl    = document.getElementById('duration');

  let currentTrackData = null;
  let isPlaying = false;

  /* 3. Fetch JSON */
  async function getCurrentlyPlaying(){
    try{
      const res = await fetch(SPOTIFY_API_ENDPOINT);
      if(!res.ok) throw new Error('API '+res.status);
      const data = await res.json();
      if(data.currentTrack || data.lastPlayed){currentTrackData=data;updateTrackDisplay(data);}else{showNoMusic();}
    }catch(e){console.error(e);showOffline();}
  }

  /* 4. Render + pick player */
  function updateTrackDisplay(data){
    const track = data.currentTrack || data.lastPlayed;
    if(!track) return showNoMusic();

    trackNameEl.textContent=track.name;
    trackArtistEl.textContent=track.artists.join(', ');

    // art
    if(track.albumArt){albumArtBox.innerHTML='';const img=new Image();img.className='album-art';img.src=track.albumArt;albumArtBox.appendChild(img);}    

    if(track.previewUrl){ // use HTML5 preview
      htmlPlayerEl.src = track.previewUrl;
      htmlPlayerEl.style.display='';
      embedFrame.style.display='none';
      htmlPlayerEl.play().catch(()=>{});
      playBtn.textContent='⏸';
      isPlaying=true;
    }else if(track.id){   // fallback to embed
      embedFrame.src=`https://open.spotify.com/embed/track/${track.id}?utm_source=generator&theme=0`;
      embedFrame.style.display='';
      htmlPlayerEl.pause(); htmlPlayerEl.style.display='none';
      playBtn.textContent='▶';
      isPlaying=false;
    }

    durationEl.textContent = formatTime(track.duration);
    if(data.isPlaying && data.progress){
      progressBar.style.width=(data.progress/track.duration)*100+'%';
      currentTimeEl.textContent=formatTime(data.progress);
    }else{progressBar.style.width='0%';currentTimeEl.textContent='0:00';}
  }

  /* 5. Helpers */
  function showNoMusic(){htmlPlayerEl.style.display='none';embedFrame.style.display='none';trackNameEl.textContent='no recent activity';trackArtistEl.textContent='play something on spotify';}
  function showOffline(){htmlPlayerEl.style.display='none';embedFrame.style.display='none';trackNameEl.textContent='connection error';trackArtistEl.textContent='spotify api offline';}
  const formatTime=ms=>{const s=Math.floor(ms/1000),m=Math.floor(s/60);return m+':'+(s%60).toString().padStart(2,'0')};

  /* 6. Play / pause button */
  playBtn.onclick=()=>{
    if(!currentTrackData) return getCurrentlyPlaying();
    const usePreview=!!(currentTrackData.currentTrack||currentTrackData.lastPlayed).previewUrl;
    if(usePreview){
      if(isPlaying){htmlPlayerEl.pause();playBtn.textContent='▶';isPlaying=false;}
      else{htmlPlayerEl.play().then(()=>{playBtn.textContent='⏸';isPlaying=true;}).catch(()=>{});}
    }else{ // toggle embed visibility
      const show = embedFrame.style.display==='none';
      embedFrame.style.display = show?'':'none';
      playBtn.textContent = show?'⏸':'▶';
    }
  };

  /* 7. Seek bar (preview only) */
  function seekTo(e){if(!htmlPlayerEl.duration)return;const pct=e.offsetX/e.currentTarget.offsetWidth;htmlPlayerEl.currentTime=pct*htmlPlayerEl.duration;}

  /* 8. Live progress for preview */
  htmlPlayerEl.addEventListener('timeupdate',()=>{
    if(!isPlaying)return;progressBar.style.width=(htmlPlayerEl.currentTime/htmlPlayerEl.duration)*100+'%';currentTimeEl.textContent=formatTime(htmlPlayerEl.currentTime*1000);
  });

  // kickoff + polling every 30 s
  getCurrentlyPlaying();
  setInterval(getCurrentlyPlaying,30000);
  </script>
  <!-- ─────────────────────────────────────────────────────── -->
</body>
</html>
